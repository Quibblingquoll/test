<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Kaboom Platformer – single jump fix</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body { margin: 0; height: 100%; background:#5c94fc; overflow: hidden; }
    .hud {
      position: fixed; inset: 12px auto auto 12px;
      padding: 8px 10px; background: rgba(0,0,0,.35); color: #fff; 
      font: 14px/1.2 system-ui, sans-serif; border-radius: 8px;
      user-select: none; pointer-events: none;
    }
  </style>
</head>
<body>
  <div class="hud">← → to move • SPACE / W / ↑ to jump</div>

  <script type="module">
    import kaboom from "https://unpkg.com/kaboom/dist/kaboom.mjs";

    const k = kaboom({
      background: [92, 148, 252],
      width: 960,
      height: 540,
      letterbox: true,
      crisp: true,
      global: false,
    });

    const {
      add, rect, pos, color, area, outline, body, anchor, opacity,
      width, height, vec2, onUpdate, setGravity, camPos, time,
      isKeyDown, onKeyPress
    } = k;

    // Prevent page scrolling on Space/Arrows so canvas keeps focus
    window.addEventListener("keydown", (e) => {
      if (["Space", "ArrowUp", "KeyW", "ArrowLeft", "ArrowRight", "KeyA", "KeyD"].includes(e.code)) {
        e.preventDefault();
      }
    }, { capture: true });

    setGravity(1600);

    function addSolid(x, y, w, h, col = [90, 200, 100]) {
      return add([
        rect(w, h),
        pos(x, y),
        area(),
        body({ isStatic: true }),
        color(...col),
        outline(2),
        anchor("topleft"),
        "solid",
      ]);
    }

    const floorH = 48;
    addSolid(-2000, height() - floorH, 5000, floorH, [80, 170, 90]);

    const platforms = [
      [260, 420, 140, 24],
      [500, 360, 120, 24],
      [720, 300, 160, 24],
      [980, 380, 140, 24],
      [1250, 320, 160, 24],
      [1500, 260, 140, 24],
      [1800, 340, 160, 24],
      [2050, 290, 160, 24],
    ];
    platforms.forEach(([x,y,w,h]) => addSolid(x,y,w,h,[100,190,220]));

    const SPEED = 240;
    const JUMP_FORCE = 540;

    const player = add([
      rect(20, 28),
      color(255, 224, 180),
      outline(2),
      pos(80, 0),
      area({ shape: new k.Rect(k.vec2(0, 2), 20, 26) }),
      body(),
      anchor("center"),
      "player",
    ]);

    const faceL = add([
      rect(3, 3),
      color(50, 50, 50),
      pos(0, 0),
      anchor("center"),
      opacity(0.8),
      { owner: player }
    ]);
    const faceR = add([
      rect(3, 3),
      color(50, 50, 50),
      pos(0, 0),
      anchor("center"),
      opacity(0.8),
      { owner: player }
    ]);

    onUpdate(() => {
      if (isKeyDown("left") || isKeyDown("a"))  player.move(-SPEED, 0);
      if (isKeyDown("right")|| isKeyDown("d"))  player.move(SPEED, 0);
      camPos(vec2(player.pos.x, height() / 2));
      const dir = (isKeyDown("left") || isKeyDown("a")) ? -1 :
                  (isKeyDown("right")|| isKeyDown("d")) ?  1 : 0;
      faceL.pos = player.pos.add(vec2(-5 + dir, -4));
      faceR.pos = player.pos.add(vec2( 5 + dir, -4));
      if (player.pos.y > height() + 200) {
        player.pos = vec2(80, 0);
        player.vel = vec2(0, 0);
      }
      // tiny idle bob
      const bob = Math.sin(time() * 6) * 0.5;
      player.scale = vec2(1, 1 + bob * 0.01);
    });

    // Single, immediate jump only (no buffering)
    const tryJump = () => {
      if (player.isGrounded()) player.jump(JUMP_FORCE);
    };
    onKeyPress("space", tryJump);
    onKeyPress("w", tryJump);
    onKeyPress("up", tryJump);

    const goal = add([
      rect(10, 60),
      color(250, 220, 60),
      outline(2),
      pos(2200, height() - floorH - 60),
      area(),
      body({ isStatic: true }),
      anchor("topleft"),
      "goal",
    ]);

    player.onCollide("goal", () => {
      player.jump(JUMP_FORCE * 1.1);
    });
  </script>
</body>
</html>
